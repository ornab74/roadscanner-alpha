# RoadScanner Alpha (`main.py`) â€“ Setup, Env Vars, and Feature Validation

This repository runs a single-file Flask application from `main.py`.

## Quick start

```bash
pip install -r requirements.txt
export INVITE_CODE_SECRET_KEY='replace-with-a-long-random-secret'
export admin_username='admin'
export admin_pass='A-Very-Strong-Password-123!'
# Optional: disable native OQS import for local/dev if liboqs isn't installed
export ENABLE_OQS_IMPORT=0
export STRICT_PQ2_ONLY=0
python main.py
```

Default bind in current code path is `http://127.0.0.1:3000`.

---

## REQUIRED environment variables (hard requirements)

These must be set or app startup will fail:

1. `INVITE_CODE_SECRET_KEY`
   - Purpose: Flask secret/session/CSRF root secret and invite-code cryptographic operations.
   - Recommendation: 32+ random bytes (or long random string).

2. `admin_username`
   - Purpose: bootstrap/ensure admin account username.

3. `admin_pass`
   - Purpose: bootstrap/ensure admin account password.
   - Note: strength checks are enforced; weak values are rejected.

---

## Recommended local-development env profile

```bash
export ENABLE_OQS_IMPORT=0
export STRICT_PQ2_ONLY=0
export GOOGLE_OAUTH_ENABLED=false
export CAPTCHA_ENABLED=false
export STRIPE_ENABLED=false
export EMAIL_ENABLED=false
```

This keeps external-provider dependencies off so you can validate core routes quickly.

---

## Feature flags and provider env vars

### Auth, registration, session/security
- `REGISTRATION_ENABLED`
- `SESSION_COOKIE_SAMESITE`
- `SESSION_COOKIE_SECURE`
- `ENFORCE_HTTPS`
- `PROXYFIX_ENABLED`
- `ALLOWED_ORIGINS`
- `MAX_CONTENT_LENGTH_BYTES`
- `CSP_STRICT_REPORT_ONLY`

### CAPTCHA (Turnstile/hCaptcha)
- `CAPTCHA_ENABLED`
- `CAPTCHA_PROVIDER`
- `CAPTCHA_SITE_KEY`
- `CAPTCHA_SECRET_KEY`

### Google OAuth
- `GOOGLE_OAUTH_ENABLED`
- `GOOGLE_CLIENT_ID`
- `GOOGLE_CLIENT_SECRET`
- `GOOGLE_OAUTH_REDIRECT_URI`

### Billing/Stripe
- `STRIPE_ENABLED`
- `STRIPE_SECRET_KEY`
- `STRIPE_WEBHOOK_SECRET`
- `STRIPE_PRICE_PRO_MONTHLY`
- `STRIPE_PRICE_CORP_MONTHLY`
- `STRIPE_CREDIT_PACKS_JSON`

### Email + DKIM + internal mail path
- `EMAIL_ENABLED`
- `EMAIL_FROM`
- `EMAIL_SMTP_HOST`
- `EMAIL_SMTP_PORT`
- `EMAIL_SMTP_USER`
- `EMAIL_SMTP_PASS`
- `EMAIL_OUTBOUND_SMTP_PORT`
- `EMAIL_OUTBOUND_TIMEOUT_SECONDS`
- `EMAIL_INTERNAL_SERVER`
- `EMAIL_MIN_INTERVAL_PER_RECIPIENT_SECONDS`
- `SMTP_HOST`
- `SMTP_PORT`
- `SMTP_USER`
- `SMTP_PASS`
- `SMTP_FROM`
- `DKIM_ENABLED`
- `DKIM_DOMAIN`
- `DKIM_SELECTOR`
- `DKIM_SELECTORS`
- `DKIM_PRIVATE_KEY`
- `DKIM_PRIVATE_KEY_PATH`
- `DKIM_ROTATE_DAYS`
- `PQE_MAILSIG_ENABLED`

### PQ/OQS and keystore crypto
- `ENABLE_OQS_IMPORT`
- `STRICT_PQ2_ONLY`
- `QRS_KEYSTORE_DB_PATH`
- `QRS_ENABLE_SEALED`
- `ENCRYPTION_PASSPHRASE`
- `PQ_OQS_ENABLED`
- `PQ_OQS_ENCRYPT_ENABLED`
- `PQ_OQS_SIG_ALG`
- `PQ_OQS_KEM_ALG`
- `PQ_OQS_ROTATE_DAYS`

### LLM integrations
- `LOCAL_LLM_ENABLED`
- `LLAMA_LOCAL_ENABLED`
- `LLAMA_MODEL_REPO`
- `LLAMA_MODEL_FILE`
- `LLAMA_MODELS_DIR`
- `LLAMA_EXPECTED_SHA256`
- `OPENAI_API_KEY`
- `OPENAI_MODEL`
- `OPENAI_REASONING_EFFORT`
- `GROK_API_KEY`
- `GROK_MODEL`

### Quotas/rate limiting/plan controls
- `API_DAILY_QUOTA`
- `API_FREE_CREDITS`
- `PRO_DAILY_QUOTA`
- `CORP_DAILY_QUOTA`
- `PRO_MONTHLY_CREDITS`
- `CORP_MONTHLY_CREDITS`
- `RATE_FREE_PER_MIN`
- `RATE_FREE_PER_DAY`
- `RATE_PRO_PER_MIN`
- `RATE_PRO_PER_DAY`
- `RATE_CORP_PER_MIN`
- `RATE_CORP_PER_DAY`
- `ANOM_FREE_PER_HOUR`
- `ANOM_PRO_PER_HOUR`
- `ANOM_CORP_PER_HOUR`
- `ANOM_FREE_THROTTLE_SECONDS`
- `ANOM_PRO_THROTTLE_SECONDS`
- `ANOM_CORP_THROTTLE_SECONDS`
- `ALERT_MIN_GAP_SECONDS`
- `ALERTS_DISPATCH_MAX`

### Weather/geocode/cache/runtime behavior
- `DISABLE_NOMINATIM`
- `NOMINATIM_URL`
- `NOMINATIM_USER_AGENT`
- `REVGEOCODE_CACHE_TTL_S`
- `WX_CACHE_TTL`
- `API_CACHE_TTL_SCAN_SECONDS`
- `DB_TIMEOUT_SECONDS`

### Admin/background/internal controls
- `ADMIN_CRON_TOKEN`
- `BLOG_BACKUP_PATH`
- `QRS_BG_LOCK_PATH`
- `QRS_BG_STARTED`
- `QRS_BOOTSTRAP_SHOW`
- `QRS_COMPRESS_MIN`
- `QRS_ENV_CAP_BYTES`
- `QRS_ROTATE_SESSION_KEY`
- `QRS_SESSION_KEY_ROTATION_PERIOD_SECONDS`
- `QRS_SESSION_KEY_ROTATION_LOOKBACK`
- `CTX_FREE_MAX_TOKENS`
- `CTX_PRO_MAX_TOKENS`
- `CTX_CORP_MAX_TOKENS`

---

## Complete env var index (alphabetical)

`ADMIN_CRON_TOKEN`, `ALERTS_DISPATCH_MAX`, `ALERT_MIN_GAP_SECONDS`, `ALLOWED_ORIGINS`, `ANOM_CORP_PER_HOUR`, `ANOM_CORP_THROTTLE_SECONDS`, `ANOM_FREE_PER_HOUR`, `ANOM_FREE_THROTTLE_SECONDS`, `ANOM_PRO_PER_HOUR`, `ANOM_PRO_THROTTLE_SECONDS`, `API_CACHE_TTL_SCAN_SECONDS`, `API_DAILY_QUOTA`, `API_FREE_CREDITS`, `API_NONCE_TTL_SECONDS`, `API_SIG_TTL_SECONDS`, `BLOG_BACKUP_PATH`, `CAPTCHA_ENABLED`, `CAPTCHA_PROVIDER`, `CAPTCHA_SECRET_KEY`, `CAPTCHA_SITE_KEY`, `CORP_DAILY_QUOTA`, `CORP_MONTHLY_CREDITS`, `CSP_STRICT_REPORT_ONLY`, `CTX_CORP_MAX_TOKENS`, `CTX_FREE_MAX_TOKENS`, `CTX_PRO_MAX_TOKENS`, `DB_TIMEOUT_SECONDS`, `DISABLE_NOMINATIM`, `DKIM_DOMAIN`, `DKIM_ENABLED`, `DKIM_PRIVATE_KEY`, `DKIM_PRIVATE_KEY_PATH`, `DKIM_ROTATE_DAYS`, `DKIM_SELECTOR`, `DKIM_SELECTORS`, `EMAIL_ENABLED`, `EMAIL_FROM`, `EMAIL_INTERNAL_SERVER`, `EMAIL_MIN_INTERVAL_PER_RECIPIENT_SECONDS`, `EMAIL_OUTBOUND_SMTP_PORT`, `EMAIL_OUTBOUND_TIMEOUT_SECONDS`, `EMAIL_SMTP_HOST`, `EMAIL_SMTP_PASS`, `EMAIL_SMTP_PORT`, `EMAIL_SMTP_USER`, `ENABLE_OQS_IMPORT`, `ENCRYPTION_PASSPHRASE`, `ENFORCE_HTTPS`, `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `GOOGLE_OAUTH_ENABLED`, `GOOGLE_OAUTH_REDIRECT_URI`, `GROK_API_KEY`, `GROK_MODEL`, `INVITE_CODE_SECRET_KEY`, `LLAMA_EXPECTED_SHA256`, `LLAMA_LOCAL_ENABLED`, `LLAMA_MODELS_DIR`, `LLAMA_MODEL_FILE`, `LLAMA_MODEL_REPO`, `LOCAL_LLM_ENABLED`, `MAX_CONTENT_LENGTH_BYTES`, `NOMINATIM_URL`, `NOMINATIM_USER_AGENT`, `OPENAI_API_KEY`, `OPENAI_MODEL`, `OPENAI_REASONING_EFFORT`, `PQE_MAILSIG_ENABLED`, `PQ_OQS_ENABLED`, `PQ_OQS_ENCRYPT_ENABLED`, `PQ_OQS_KEM_ALG`, `PQ_OQS_ROTATE_DAYS`, `PQ_OQS_SIG_ALG`, `PROXYFIX_ENABLED`, `PRO_DAILY_QUOTA`, `PRO_MONTHLY_CREDITS`, `QRS_BG_LOCK_PATH`, `QRS_BG_STARTED`, `QRS_BOOTSTRAP_SHOW`, `QRS_COMPRESS_MIN`, `QRS_ENABLE_SEALED`, `QRS_ENV_CAP_BYTES`, `QRS_KEYSTORE_DB_PATH`, `QRS_ROTATE_SESSION_KEY`, `QRS_SESSION_KEY_ROTATION_LOOKBACK`, `QRS_SESSION_KEY_ROTATION_PERIOD_SECONDS`, `RATE_CORP_PER_DAY`, `RATE_CORP_PER_MIN`, `RATE_FREE_PER_DAY`, `RATE_FREE_PER_MIN`, `RATE_PRO_PER_DAY`, `RATE_PRO_PER_MIN`, `REGISTRATION_ENABLED`, `REVGEOCODE_CACHE_TTL_S`, `SESSION_COOKIE_SAMESITE`, `SESSION_COOKIE_SECURE`, `SMTP_FROM`, `SMTP_HOST`, `SMTP_PASS`, `SMTP_PORT`, `SMTP_USER`, `STRICT_PQ2_ONLY`, `STRIPE_CREDIT_PACKS_JSON`, `STRIPE_ENABLED`, `STRIPE_PRICE_CORP_MONTHLY`, `STRIPE_PRICE_PRO_MONTHLY`, `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`, `WX_CACHE_TTL`, `admin_pass`, `admin_username`.

---

## Smoke test commands used

### Syntax
```bash
python -m py_compile main.py
```

### Startup
```bash
ENABLE_OQS_IMPORT=0 STRICT_PQ2_ONLY=0 INVITE_CODE_SECRET_KEY=dev-secret admin_username=admin admin_pass='Admin123!Strong' python main.py
```

### Route checks (unauthenticated baseline)
```bash
curl -m 6 -s -o /tmp/out -w '%{http_code}' http://127.0.0.1:3000/login
curl -m 6 -s -o /tmp/out -w '%{http_code}' http://127.0.0.1:3000/register
curl -m 6 -s -o /tmp/out -w '%{http_code}' http://127.0.0.1:3000/dashboard
curl -m 6 -s -o /tmp/out -w '%{http_code}' -X POST http://127.0.0.1:3000/start_scan
```

### Screenshot
Playwright capture is validated in this environment using Firefox engine.
